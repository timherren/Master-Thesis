<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Causal AI Agent - Chatbot</title>
    <!-- Tailwind CSS - Note: CDN is for development only. For production, use PostCSS or Tailwind CLI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Plotly - Using specific version instead of latest -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <!-- Cytoscape.js for interactive DAG editor -->
    <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
    <style>
        /* Professional Medical Software Styling */
        :root {
            --primary-blue: #2C5F7D;
            --secondary-blue: #4A90A4;
            --accent-blue: #6BA3B8;
            --surface-blue: #F4FAFD;
            --assistant-read-width: 76ch;
            --text-dark: #1F2937;
            --text-medium: #4B5563;
            --text-light: #6B7280;
            --bg-light: #F9FAFB;
            --bg-white: #FFFFFF;
            --border-color: #E5E7EB;
            --success-green: #059669;
            --warning-orange: #D97706;
            --error-red: #DC2626;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-dark);
            background:
                radial-gradient(1200px 500px at 10% -20%, #E7F3F8 0%, transparent 60%),
                radial-gradient(1000px 500px at 95% -10%, #EEF7FB 0%, transparent 55%),
                var(--bg-light);
        }
        
        .chat-container {
            width: 100%;
            max-width: none;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-light);
            border-left: 1px solid rgba(44, 95, 125, 0.08);
            border-right: 1px solid rgba(44, 95, 125, 0.08);
        }
        
        .message {
            padding: 1rem 1.1rem;
            margin: 0.58rem 0;
            border-radius: 0.9rem;
            max-width: 84%;
            word-wrap: break-word;
            box-shadow: 0 6px 20px rgba(15, 23, 42, 0.06);
            line-height: 1.62;
            font-size: 0.98rem;
        }
        
        .message.user {
            background: linear-gradient(180deg, #FFFFFF 0%, #F8FCFF 100%);
            border: 1px solid #DDEAF2;
            margin-left: auto;
            text-align: right;
            color: var(--text-dark);
            border-bottom-right-radius: 0.35rem;
            max-width: min(72ch, 82%);
            font-size: 0.96rem;
        }
        
        .message.assistant {
            background: linear-gradient(180deg, #FFFFFF 0%, #FBFEFF 100%);
            border: 1px solid #E4EEF3;
            border-left: 4px solid var(--primary-blue);
            margin-right: auto;
            color: var(--text-dark);
            border-bottom-left-radius: 0.35rem;
            max-width: min(var(--assistant-read-width), 86%);
            line-height: 1.68;
            font-size: 1rem;
        }

        .message p {
            margin: 0.3rem 0;
        }

        .message strong {
            color: #1F3A4A;
            font-weight: 650;
        }

        #messages-container {
            scroll-behavior: smooth;
            padding: 1rem clamp(1rem, 2vw, 1.5rem) 1.2rem clamp(1rem, 2vw, 1.5rem);
        }

        #messages-container::-webkit-scrollbar {
            width: 10px;
        }

        #messages-container::-webkit-scrollbar-thumb {
            background: #C7DCE7;
            border-radius: 999px;
            border: 2px solid #F3F8FB;
        }

        #messages-container::-webkit-scrollbar-track {
            background: #F3F8FB;
        }
        
        .code-block {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 0.25rem;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .progress-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--primary-blue);
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Loading indicator with animated dots */
        .loading-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            color: var(--text-medium);
            font-style: italic;
        }
        
        .loading-dots {
            display: inline-flex;
            gap: 0.25rem;
        }
        
        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--primary-blue);
            animation: loading-bounce 1.4s ease-in-out infinite both;
        }
        
        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes loading-bounce {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Calculating message styling */
        .calculating-message {
            background-color: #F0F7FA;
            border-left: 3px solid var(--primary-blue);
            padding: 1rem;
            margin: 0.75rem 0;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-style: italic;
            color: var(--text-medium);
        }
        
        .step-indicator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background-color: #F7FCFF;
            border-left: 3px solid var(--primary-blue);
            margin: 0.5rem 0;
            font-size: 0.875rem;
            color: var(--text-medium);
            border-radius: 0.6rem;
        }
        
        .step-indicator.completed {
            border-left-color: var(--success-green);
        }
        
        .step-indicator.active {
            border-left-color: var(--primary-blue);
            background-color: #F0F7FA;
        }
        
        /* Plot images styling */
        .message img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            border: 1px solid #DDE7EE;
            margin: 1rem 0;
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.12);
            cursor: zoom-in;
        }

        .action-suggestions {
            box-shadow: inset 0 0 0 1px #DAEAF3;
            background: linear-gradient(180deg, #F2F8FC 0%, #EEF6FB 100%);
            border-radius: 0.85rem;
        }

        .action-btn {
            border-radius: 0.75rem !important;
        }

        #message-input {
            border-radius: 0.8rem !important;
            border-color: #D4E2EA !important;
            background: #FFFFFF;
        }

        #message-input:focus {
            box-shadow: 0 0 0 3px rgba(44, 95, 125, 0.14) !important;
            border-color: #7CA9BC !important;
        }
        
        .message.assistant img {
            display: block;
            margin-left: 0;
            margin-right: auto;
        }
        
        /* DAG Editor Modal */
        .dag-editor-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .dag-editor-overlay.active {
            display: flex;
        }
        .dag-editor-modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .dag-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-light);
        }
        .dag-editor-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-blue);
            margin: 0;
        }
        .dag-editor-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem 1.5rem;
            overflow: hidden;
        }
        #dag-editor-canvas {
            flex: 1;
            min-height: 400px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: #fafbfc;
        }
        .dag-editor-instructions {
            font-size: 0.85rem;
            color: var(--text-medium);
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }
        .dag-editor-instructions strong {
            color: var(--primary-blue);
        }
        .dag-editor-status {
            font-size: 0.85rem;
            color: var(--text-medium);
            margin-top: 0.5rem;
            min-height: 1.5rem;
        }
        .dag-editor-status.selecting {
            color: var(--primary-blue);
            font-weight: 500;
        }
        .dag-editor-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            background: var(--bg-light);
            gap: 0.75rem;
        }
        .dag-editor-footer .edge-list {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-medium);
            max-height: 3rem;
            overflow-y: auto;
        }
        .dag-editor-btn {
            padding: 0.6rem 1.5rem;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }
        .dag-editor-btn.primary {
            background: var(--primary-blue);
            color: white;
        }
        .dag-editor-btn.primary:hover {
            background: #1e4a5f;
        }
        .dag-editor-btn.secondary {
            background: white;
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }
        .dag-editor-btn.secondary:hover {
            background: var(--bg-light);
        }
        .dag-editor-btn.danger {
            background: var(--error-red);
            color: white;
        }
        .dag-editor-btn.danger:hover {
            background: #b91c1c;
        }
        .intervention-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }
        .intervention-overlay.active {
            display: flex;
        }
        .plot-zoom-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(9, 13, 20, 0.88);
            z-index: 1300;
            align-items: center;
            justify-content: center;
        }
        .plot-zoom-overlay.active {
            display: flex;
        }
        .plot-zoom-modal {
            width: 94vw;
            height: 90vh;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(3px);
        }
        .plot-zoom-toolbar {
            display: flex;
            gap: 0.45rem;
            align-items: center;
            justify-content: flex-end;
            padding: 0.55rem 0.7rem;
            border-bottom: 1px solid rgba(255,255,255,0.16);
            background: rgba(18, 26, 40, 0.55);
        }
        .plot-zoom-btn {
            background: rgba(255,255,255,0.12);
            color: #E5EDF5;
            border: 1px solid rgba(255,255,255,0.22);
            border-radius: 6px;
            padding: 0.28rem 0.6rem;
            font-size: 0.84rem;
        }
        .plot-zoom-btn:hover {
            background: rgba(255,255,255,0.22);
        }
        .plot-zoom-stage {
            flex: 1;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
        }
        .plot-zoom-stage.dragging {
            cursor: grabbing;
        }
        #plot-zoom-image {
            transform-origin: center center;
            transition: transform 0.08s ease-out;
            max-width: none;
            max-height: none;
            user-select: none;
            -webkit-user-drag: none;
        }
        .intervention-modal {
            background: white;
            border-radius: 12px;
            width: 92%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .intervention-body {
            padding: 1rem 1.25rem;
            overflow: auto;
        }
        .intervention-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 0.75rem;
        }
        .intervention-plot-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }
        .intervention-panel {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: #fff;
            padding: 0.5rem;
            min-height: 360px;
        }
        .intervention-panel h3 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary-blue);
            margin: 0.25rem 0 0.5rem 0.25rem;
        }
        .workflow-strip {
            background: linear-gradient(180deg, #FFFFFF 0%, #F5FAFD 100%);
            border-bottom: 1px solid #D9E8F1;
            padding: 0.45rem 0.75rem 0.55rem 0.75rem;
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }
        .workflow-pill {
            font-size: 0.78rem;
            padding: 0.23rem 0.58rem;
            border-radius: 9999px;
            border: 1px solid #D4E3EC;
            color: var(--text-medium);
            background: #F8FCFF;
        }
        .workflow-pill.active {
            border-color: #4A90A4;
            background: #E6F3F8;
            color: #1F4E63;
            font-weight: 600;
        }
        .workflow-pill.completed {
            border-color: #2D9B76;
            background: #E9F8F2;
            color: #166534;
        }
        .chat-container > header {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid #D8E6EE;
        }
        #status-text {
            color: #476A7B;
            font-weight: 500;
        }
        .message.assistant h1,
        .message.assistant h2,
        .message.assistant h3 {
            margin: 0.6rem 0 0.35rem 0;
            color: #1E445A;
            line-height: 1.35;
        }
        .message.assistant ul,
        .message.assistant ol {
            margin: 0.4rem 0 0.4rem 1.2rem;
        }
        .message.assistant li {
            margin: 0.2rem 0;
        }
        .message.assistant pre {
            background: #0F172A;
            color: #E2E8F0;
            border: 1px solid #243147;
            border-radius: 0.65rem;
            padding: 0.8rem;
            margin: 0.55rem 0;
            overflow-x: auto;
        }
        .message.assistant code {
            background: #EEF5FA;
            color: #1E445A;
            border: 1px solid #D8E7F0;
            border-radius: 0.35rem;
            padding: 0.05rem 0.35rem;
            font-size: 0.88em;
        }
        .message.assistant pre code {
            background: transparent;
            border: none;
            color: inherit;
            padding: 0;
        }
        .message.assistant blockquote {
            border-left: 3px solid #87B2C5;
            background: #F4FAFD;
            margin: 0.5rem 0;
            padding: 0.4rem 0.7rem;
            color: #2B5569;
            border-radius: 0.45rem;
        }
        #intervention-fit-overlay {
            width: 100%;
            max-height: 320px;
            object-fit: contain;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: #fafbfc;
        }
        #intervention-fit-overlay-note {
            font-size: 0.82rem;
            color: var(--text-medium);
            padding: 0.5rem;
        }
        @media (max-width: 768px) {
            .chat-container {
                max-width: 100%;
                border-left: none;
                border-right: none;
            }
            .chat-container > header {
                padding: 0.75rem 0.9rem !important;
            }
            .chat-container > header h1 {
                font-size: 1.12rem !important;
                line-height: 1.25;
            }
            #download-report-btn {
                padding: 0.45rem 0.7rem !important;
                font-size: 0.75rem !important;
            }
            .workflow-strip {
                padding: 0.4rem 0.55rem 0.45rem 0.55rem;
                gap: 0.3rem;
                flex-wrap: nowrap;
                overflow-x: auto;
                scrollbar-width: thin;
            }
            .workflow-pill {
                white-space: nowrap;
                font-size: 0.72rem;
                padding: 0.2rem 0.5rem;
            }
            #messages-container {
                padding: 0.7rem 0.6rem 0.9rem 0.6rem;
            }
            .message {
                max-width: 95%;
                margin: 0.45rem 0;
                padding: 0.78rem 0.82rem;
                border-radius: 0.78rem;
            }
            .message.assistant {
                max-width: 94%;
                font-size: 0.96rem;
                line-height: 1.58;
            }
            .message.user {
                max-width: 90%;
                font-size: 0.93rem;
            }
            .message.assistant ul,
            .message.assistant ol {
                margin-left: 1rem;
            }
            #message-input {
                font-size: 16px !important;
                padding: 0.62rem 0.72rem !important;
            }
            #send-btn,
            #upload-btn {
                padding: 0.6rem 0.82rem !important;
                border-radius: 0.7rem !important;
            }
            .intervention-grid {
                grid-template-columns: 1fr;
            }
            .intervention-plot-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="chat-container">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 p-4 shadow-sm">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-semibold" style="color: var(--primary-blue);">Causal Analysis Platform</h1>
                <div class="flex gap-3">
                    <button id="download-report-btn" class="px-4 py-2 rounded text-sm font-medium transition-colors" style="background-color: var(--secondary-blue); color: white;" onmouseover="this.style.backgroundColor='#3a7a8f'" onmouseout="this.style.backgroundColor='var(--secondary-blue)'">
                        Download Report
                    </button>
                </div>
            </div>
        </header>
        <div id="workflow-strip" class="workflow-strip"></div>
        
        <!-- Messages Area -->
        <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4">
            <div class="message assistant">
                <p><strong>Welcome to the Causal Analysis Platform.</strong></p>
                <p class="mt-2" style="color: var(--text-medium);">I guide you through a complete causal inference workflow:</p>
                <ol class="list-decimal list-inside mt-2 space-y-1" style="color: var(--text-medium);">
                    <li><strong>Propose DAG</strong> - I suggest a causal structure based on your question</li>
                    <li><strong>Test DAG</strong> - Validate it against your data using CI tests</li>
                    <li><strong>Revise DAG</strong> - Fix inconsistencies if needed</li>
                    <li><strong>Fit Model</strong> - Train a TRAM-DAG model</li>
                    <li><strong>Answer Questions</strong> - Compute ATE, interventions, associations</li>
                    <li><strong>Generate Reports</strong> - Get PDF reports with all results</li>
                </ol>

                <div class="mt-4 p-3 rounded-lg border" style="background-color: #F8FCFF; border-color: #DDEAF2;">
                    <p class="font-semibold text-sm mb-2" style="color: var(--primary-blue);">LLM Models Used:</p>
                    <ul class="list-disc list-inside text-sm space-y-1 ml-2" style="color: var(--text-medium);">
                        <li><strong>Decision model (fast):</strong> chooses workflow steps and tool calls.</li>
                        <li><strong>Interpretation model (larger):</strong> answers general questions and explains computed results in depth.</li>
                    </ul>
                </div>

                <div class="mt-4 p-3 rounded-lg border" style="background-color: #F8FCFF; border-color: #DDEAF2;">
                    <p class="font-semibold text-sm mb-2" style="color: var(--primary-blue);">Where Files Are Stored:</p>
                    <ul class="list-disc list-inside text-sm space-y-1 ml-2" style="color: var(--text-medium);">
                        <li><strong>PDF reports:</strong> <code>causal_ai_chatbot/app/runtime/reports/</code></li>
                        <li><strong>Experiment outputs:</strong> <code>causal_ai_chatbot/app/runtime/experiments/&lt;session_id&gt;/fit_&lt;timestamp&gt;/</code></li>
                        <li><strong>Reproducible code:</strong> inside each fit folder at <code>scripts/</code> and <code>reproducible_package/</code></li>
                    </ul>
                </div>
                
                <div class="mt-4 p-4 rounded-lg border" style="background-color: #F0F7FA; border-color: var(--border-color);">
                    <p class="font-semibold mb-3" style="color: var(--primary-blue);">What You Can Do:</p>
                    
                    <div class="mb-4">
                        <p class="font-semibold text-sm mb-2" style="color: var(--primary-blue);">Plotting & Visualization:</p>
                        <ul class="list-disc list-inside text-sm space-y-1 ml-2" style="color: var(--text-medium);">
                            <li><strong>Training Loss History</strong> - Model training progress over epochs</li>
                            <li><strong>Sampling Distributions</strong> - Histograms of variables from model sampling</li>
                            <li><strong>DAG Visualization</strong> - Causal structure graph</li>
                            <li><strong>All Plots Together</strong> - Generate all visualizations at once</li>
                        </ul>
                    </div>
                    
                    <div class="mb-4">
                        <p class="font-semibold text-sm mb-2" style="color: var(--primary-blue);">Questions & Queries:</p>
                        <ul class="list-disc list-inside text-sm space-y-1 ml-2" style="color: var(--text-medium);">
                            <li><strong>ATE Queries</strong> - Average Treatment Effect ("compute the ate")</li>
                            <li><strong>Intervention Queries</strong> - Ask intervention questions in natural language</li>
                            <li><strong>Natural Language</strong> - Ask questions in plain English</li>
                        </ul>
                    </div>
                    
                    <div class="mb-4">
                        <p class="font-semibold text-sm mb-2" style="color: var(--primary-blue);">Simulations:</p>
                        <ul class="list-disc list-inside text-sm space-y-1 ml-2" style="color: var(--text-medium);">
                            <li><strong>Single Variable Interventions</strong> - Set one variable to a value and observe effects</li>
                            <li><strong>Custom Sample Sizes</strong> - Specify how many samples to generate</li>
                            <li><strong>Multiple Variable Comparisons</strong> - Compare treatment vs. control via ATE</li>
                            <li><strong>Observational & Interventional Sampling</strong> - Sample with or without interventions</li>
                        </ul>
                    </div>
                </div>
                
                <div class="action-suggestions mt-4 p-4 rounded-lg border" style="background-color: #F0F7FA; border-color: var(--border-color);">
                    <p class="font-semibold mb-3" style="color: var(--primary-blue);">Get Started:</p>
                    <div class="space-y-2">
                        <button 
                            onclick="document.getElementById('file-input').click()"
                            class="action-btn w-full text-left px-4 py-3 rounded-lg transition-colors"
                            style="background-color: white; border: 1px solid var(--border-color);"
                            onmouseover="this.style.backgroundColor='#F0F7FA'; this.style.borderColor='var(--primary-blue)';"
                            onmouseout="this.style.backgroundColor='white'; this.style.borderColor='var(--border-color)';"
                        >
                            <div class="font-medium" style="color: var(--primary-blue);">Upload your data</div>
                            <div class="text-sm mt-1" style="color: var(--text-medium);">Upload a CSV or Excel file to begin analysis</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="bg-white border-t border-gray-200 p-4">
            <div class="flex gap-2 mb-2">
                <input 
                    type="file" 
                    id="file-input" 
                    accept=".csv,.xlsx,.xls"
                    class="hidden"
                    onchange="uploadFile()"
                >
                <input
                    type="file"
                    id="dag-file-input"
                    accept=".csv"
                    class="hidden"
                    onchange="uploadDagCsvFile()"
                >
                <button 
                    id="upload-btn" 
                    onclick="document.getElementById('file-input').click()"
                    class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
                    title="Upload data file"
                >
                    Upload Data
                </button>
                <input 
                    type="text" 
                    id="message-input" 
                    placeholder="Ask a causal question or describe your analysis..."
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    onkeypress="if(event.key === 'Enter') sendMessage()"
                >
                <button 
                    id="send-btn" 
                    onclick="sendMessage()"
                    class="px-6 py-2 text-white rounded-lg disabled:bg-gray-400 transition-colors"
                    style="background-color: var(--secondary-blue);"
                    onmouseover="this.style.backgroundColor='#3a7a8f'"
                    onmouseout="this.style.backgroundColor='var(--secondary-blue)'"
                >
                    Send
                </button>
            </div>
            <div class="mt-2 text-sm text-gray-500">
                <span id="status-text">Ready</span>
            </div>
        </div>
    </div>
    
    <!-- DAG Editor Modal -->
    <div id="dag-editor-overlay" class="dag-editor-overlay">
        <div class="dag-editor-modal">
            <div class="dag-editor-header">
                <h2>Interactive DAG Editor</h2>
                <button onclick="closeDagEditor()" class="dag-editor-btn secondary" style="padding: 0.3rem 0.8rem;">✕</button>
            </div>
            <div class="dag-editor-body">
                <div class="dag-editor-instructions">
                    <strong>Click a source node</strong>, then <strong>click a target node</strong> to add a directed edge.
                    <strong>Click on an edge</strong> to remove it.
                </div>
                <div id="dag-editor-canvas"></div>
                <div id="dag-editor-status" class="dag-editor-status">Select a source node to begin.</div>
            </div>
            <div class="dag-editor-footer">
                <div class="edge-list" id="dag-editor-edge-list">No edges yet.</div>
                <div style="display:flex; gap:0.5rem;">
                    <button onclick="clearDagEditorEdges()" class="dag-editor-btn danger">Clear All</button>
                    <button onclick="closeDagEditor()" class="dag-editor-btn secondary">Cancel</button>
                    <button onclick="saveDagFromEditor(true)" class="dag-editor-btn secondary">Save + Re-test</button>
                    <button onclick="saveDagFromEditor()" class="dag-editor-btn primary">Save DAG</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Intervention Chooser Modal -->
    <div id="intervention-overlay" class="intervention-overlay">
        <div class="intervention-modal">
            <div class="dag-editor-header">
                <h2>Choose Intervention Values</h2>
                <button onclick="closeInterventionChooser()" class="dag-editor-btn secondary" style="padding: 0.3rem 0.8rem;">✕</button>
            </div>
            <div class="intervention-body">
                <div class="dag-editor-instructions">
                    Review the treatment distribution and choose control/treated values to use for ATE.
                </div>
                <div class="intervention-plot-grid">
                    <div class="intervention-panel">
                        <h3>Treatment Distribution</h3>
                        <div id="intervention-plot" style="height: 320px;"></div>
                    </div>
                </div>
                <div class="intervention-grid">
                    <div>
                        <label for="control-value-input" class="text-sm font-medium" style="color: var(--text-dark);">Control value</label>
                        <input id="control-value-input" type="number" step="any" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded">
                    </div>
                    <div>
                        <label for="treated-value-input" class="text-sm font-medium" style="color: var(--text-dark);">Treated value</label>
                        <input id="treated-value-input" type="number" step="any" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded">
                    </div>
                </div>
                <div class="mt-3" style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                    <button onclick="setInterventionPreset('p25_p75')" class="dag-editor-btn secondary">Use p25 -> p75</button>
                    <button onclick="setInterventionPreset('p10_p90')" class="dag-editor-btn secondary">Use p10 -> p90</button>
                    <button onclick="setInterventionPreset('defaults')" class="dag-editor-btn secondary">Use defaults</button>
                </div>
                <div id="intervention-status" class="dag-editor-status mt-2">Choose values and click Apply values.</div>
            </div>
            <div class="dag-editor-footer">
                <div class="edge-list">The selected values will be sent directly to ATE calculation.</div>
                <div style="display:flex; gap:0.5rem;">
                    <button onclick="closeInterventionChooser()" class="dag-editor-btn secondary">Cancel</button>
                    <button onclick="applyInterventionValues()" class="dag-editor-btn primary">Apply values</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Plot Zoom Overlay -->
    <div id="plot-zoom-overlay" class="plot-zoom-overlay" onclick="closePlotZoom(event)">
        <div class="plot-zoom-modal" onclick="event.stopPropagation()">
            <div class="plot-zoom-toolbar">
                <button class="plot-zoom-btn" onclick="zoomPlotBy(0.85)">-</button>
                <button class="plot-zoom-btn" onclick="resetPlotZoom()">Reset</button>
                <button class="plot-zoom-btn" onclick="zoomPlotBy(1.2)">+</button>
                <button class="plot-zoom-btn" onclick="closePlotZoom()">Close</button>
            </div>
            <div id="plot-zoom-stage" class="plot-zoom-stage">
                <img id="plot-zoom-image" alt="Zoomed plot">
            </div>
        </div>
    </div>

    <script>
        // Try to restore session ID from localStorage
        let sessionId = localStorage.getItem('chatbot_session_id') || null;
        let ws = null;
        let currentStep = null;
        let workflowPhase = 'data';
        let plotZoomScale = 1;
        let plotZoomDrag = null;
        
        if (sessionId) {
            console.log('Restored session ID from localStorage:', sessionId);
        }
        
        // Initialize WebSocket connection
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                // Ensure we have the latest session_id from localStorage
                const latestSessionId = localStorage.getItem('chatbot_session_id') || sessionId;
                if (latestSessionId && latestSessionId !== sessionId) {
                    sessionId = latestSessionId;
                    console.log('WebSocket: Updated session_id from localStorage:', sessionId);
                }
                console.log('WebSocket connected with session_id:', sessionId);
                ws.send(JSON.stringify({ type: 'init', session_id: sessionId }));
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'init') {
                    sessionId = data.session_id;
                    updateStatus('Connected');
                } else if (data.type === 'status') {
                    // Show status update
                    updateStatus(data.content || 'Processing...');
                    if (data.current_step) {
                        currentStep = data.current_step;
                    }
                    // Update loading indicator if it exists, otherwise create one
                    const existingLoading = document.getElementById('loading-indicator');
                    if (existingLoading) {
                        const statusText = existingLoading.querySelector('.loading-text');
                        if (statusText) {
                            statusText.textContent = data.content || 'Processing...';
                        }
                    } else {
                        showLoadingIndicator(data.content || 'Processing...');
                    }
                } else if (data.type === 'message') {
                    // Remove any existing loading indicators
                    hideLoadingIndicator();
                    
                    addMessage('assistant', data.content);
                    if (data.current_step) {
                        currentStep = data.current_step;
                        updateStepIndicator();
                    }
                    updateStatus('Ready');
                } else if (data.type === 'error') {
                    // Remove loading indicator on error
                    hideLoadingIndicator();
                    addMessage('assistant', data.content || 'An error occurred');
                    updateStatus('Error');
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateStatus('Connection error. Trying HTTP fallback...');
                // Fallback to HTTP
                useHttpFallback = true;
            };
            
            ws.onclose = () => {
                console.log('WebSocket closed');
                updateStatus('Disconnected');
            };
        }
        
        // Fallback to HTTP if WebSocket fails
        let useHttpFallback = false;
        
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Check if we have a session ID, warn if not
            if (!sessionId) {
                console.warn('No session ID found! Attempting to restore from localStorage...');
                sessionId = localStorage.getItem('chatbot_session_id') || null;
                if (!sessionId) {
                    addMessage('assistant', 'No session found. Please upload your data first using the "Upload Data" button.');
                    return;
                }
                console.log('Restored session ID:', sessionId);
            }
            
            // Add user message to UI
            addMessage('user', message);
            input.value = '';
            
            // Show calculating/loading indicator
            const loadingId = showLoadingIndicator();
            
            updateStatus('Processing...');
            
            try {
                if (useHttpFallback || !ws || ws.readyState !== WebSocket.OPEN) {
                    // Use HTTP fallback
                    console.log('Sending chat message with session_id:', sessionId);
                    const chatPayload = {
                        session_id: sessionId,
                        message: message
                    };
                    console.log('Chat payload:', JSON.stringify(chatPayload));
                    
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(chatPayload)
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Chat request failed:', response.status, errorText);
                        hideLoadingIndicator(loadingId);
                        addMessage('assistant', `Error: ${response.status} - ${errorText}`);
                        updateStatus('Error');
                        return;
                    }
                    
                    const data = await response.json();
                    console.log('Chat response received:', data);
                    sessionId = data.session_id;
                    // Store in localStorage
                    if (sessionId) {
                        localStorage.setItem('chatbot_session_id', sessionId);
                        console.log('Session ID updated from chat response:', sessionId);
                    }
                    currentStep = data.current_step;
                    
                    // Remove loading indicator
                    hideLoadingIndicator(loadingId);
                    
                    // Add response
                    addMessage('assistant', data.response);
                    updateStepIndicator();
                } else {
                    // Use WebSocket - CRITICAL: send session_id with message
                    const latestSessionId = localStorage.getItem('chatbot_session_id') || sessionId;
                    if (latestSessionId && latestSessionId !== sessionId) {
                        sessionId = latestSessionId;
                    }
                    console.log('WebSocket: Sending message with session_id:', sessionId);
                    ws.send(JSON.stringify({
                        type: 'message',
                        session_id: sessionId,  // CRITICAL: Include session_id
                        message: message
                    }));
                    // Response will come via WebSocket - loading indicator will be removed when message arrives
                }
                
                updateStatus('Ready');
            } catch (error) {
                console.error('Error sending message:', error);
                hideLoadingIndicator(loadingId);
                addMessage('assistant', `Error: ${error.message}\n\nPlease check the browser console (F12) and server logs for details.`);
                updateStatus('Error');
            }
        }
        
        function addMessage(role, content) {
            const container = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.id = `msg-${Date.now()}-${Math.random()}`;
            
            // Parse content for code blocks, lists, etc.
            let htmlContent = content;
            
            // Detect DAG editor trigger from backend
            if (role === 'assistant' && htmlContent.includes('<!-- OPEN_DAG_EDITOR -->')) {
                htmlContent = htmlContent.replace('<!-- OPEN_DAG_EDITOR -->', '');
                // Open the DAG editor after a short delay to let the message render
                setTimeout(() => openDagEditor(), 300);
            }
            if (role === 'assistant' && htmlContent.includes('<!-- OPEN_INTERVENTION_CHOOSER -->')) {
                htmlContent = htmlContent.replace('<!-- OPEN_INTERVENTION_CHOOSER -->', '');
                setTimeout(() => openInterventionChooser(), 300);
            }
            if (role === 'assistant') {
                inferWorkflowPhaseFromText(htmlContent);
                if (
                    reopenEditorAfterRetest &&
                    (
                        htmlContent.toLowerCase().includes('consistency test results') ||
                        htmlContent.toLowerCase().includes('stage 3: dag test')
                    )
                ) {
                    reopenEditorAfterRetest = false;
                    setTimeout(() => openDagEditor(), 350);
                }
            }
            
            // Parse action suggestions (format: "---\n\n**What would you like to do next?**\n\n1. **Label**\n   → Type: `command`\n   description\n")
            const actionSectionRegex = /---\s*\n\s*\*\*What would you like to do next\?\*\*([\s\S]*?)(?=\n\n|$)/;
            const actionMatch = htmlContent.match(actionSectionRegex);
            let actionButtons = '';
            
            if (actionMatch) {
                const actionText = actionMatch[1];
                // Extract each action (numbered list items)
                const actionRegex = /(\d+)\.\s*\*\*(.+?)\*\*\s*\n\s*→\s*Type:\s*`(.+?)`\s*\n\s*(.+?)(?=\n\n\d+\.|$)/g;
                let match;
                const actions = [];
                
                while ((match = actionRegex.exec(actionText)) !== null) {
                    actions.push({
                        label: match[2].trim(),
                        command: match[3].trim(),
                        description: match[4].trim()
                    });
                }
                
                // Create action buttons
                if (actions.length > 0) {
                    actionButtons = '<div class="action-suggestions mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">';
                    actionButtons += '<p class="font-semibold text-blue-900 mb-3">What would you like to do next?</p>';
                    actionButtons += '<div class="space-y-2">';
                    
                    actions.forEach((action, idx) => {
                        const whyLine = inferWhySuggestion(action.command, action.label, action.description);
                        actionButtons += `
                            <button 
                                onclick="sendAction('${escapeHtml(action.command)}')"
                                class="action-btn w-full text-left px-4 py-3 bg-white hover:bg-blue-100 border border-blue-300 rounded-lg transition-colors"
                                title="${escapeHtml(action.description)}"
                            >
                                <div class="font-semibold text-blue-900">${action.label}</div>
                                <div class="text-sm text-gray-600 mt-1">${action.description}</div>
                                <div class="text-xs text-blue-700 mt-1"><strong>Why:</strong> ${escapeHtml(whyLine)}</div>
                                <div class="text-xs text-gray-500 mt-1 font-mono">→ ${action.command}</div>
                            </button>
                        `;
                    });
                    
                    actionButtons += '</div>';
                    actionButtons += '<p class="text-sm text-gray-600 mt-3"><strong>Tip:</strong> You can also type your request in natural language!</p>';
                    actionButtons += '</div>';
                }
                
                // Remove action section from main content
                htmlContent = htmlContent.replace(actionSectionRegex, '');
            }
            
            // Convert markdown images FIRST (before line breaks) ![alt](url) to <img> tags
            htmlContent = htmlContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, alt, url) => {
                // Handle relative URLs
                if (url.startsWith('/api/plots/')) {
                    const cacheBuster = `t=${Date.now()}`;
                    const separator = url.includes('?') ? '&' : '?';
                    const fullUrl = window.location.origin + url + separator + cacheBuster;
                    return `<div class="my-4"><img src="${fullUrl}" alt="${escapeHtml(alt)}" class="rounded-lg border border-gray-300 shadow-md" style="max-width: 100%; height: auto; display: block;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"><p style="display:none; color: red;">Failed to load image: ${escapeHtml(url)}</p></div>`;
                }
                return `<div class="my-4"><img src="${url}" alt="${escapeHtml(alt)}" class="rounded-lg border border-gray-300 shadow-md" style="max-width: 100%; height: auto; display: block;" /></div>`;
            });
            
            // Convert markdown-style code blocks
            htmlContent = htmlContent.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre class="code-block">${escapeHtml(code)}</pre>`;
            });
            
            // Convert inline code
            htmlContent = htmlContent.replace(/`([^`]+)`/g, '<code class="bg-gray-200 px-1 rounded">$1</code>');
            
            // Convert **bold**
            htmlContent = htmlContent.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // Convert numbered lists (1. item) - but not if it's part of action suggestions
            // Use the existing actionSectionRegex variable (already declared above)
            if (!actionSectionRegex.test(htmlContent)) {
                htmlContent = htmlContent.replace(/^(\d+)\.\s+(.+)$/gm, '<li>$2</li>');
                // Only wrap if we have list items
                if (htmlContent.includes('<li>')) {
                    htmlContent = htmlContent.replace(/(<li>.*?<\/li>)/gs, '<ol class="list-decimal list-inside ml-4 my-2">$1</ol>');
                }
            }
            
            // Convert bullet lists
            htmlContent = htmlContent.replace(/^[-*]\s+(.+)$/gm, '<li>$1</li>');
            // Only wrap if we have list items and they're not already wrapped
            if (htmlContent.includes('<li>') && !htmlContent.includes('<ul') && !htmlContent.includes('<ol')) {
                htmlContent = htmlContent.replace(/(<li>.*?<\/li>)/gs, '<ul class="list-disc list-inside ml-4 my-2">$1</ul>');
            }
            
            // Clean up excessive spacing
            htmlContent = htmlContent.replace(/\n{3,}/g, '\n\n');
            
            // Convert line breaks (after images to preserve structure)
            htmlContent = htmlContent.replace(/\n\n/g, '</p><p>');
            htmlContent = htmlContent.replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = '<p>' + htmlContent + '</p>' + actionButtons;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            updateStepIndicator();
            
            return messageDiv.id;
        }

        function inferWhySuggestion(command, label, description) {
            const cmd = (command || '').toLowerCase();
            if (cmd.includes('sample')) return 'Check model fit quality against test data before effect estimation.';
            if (cmd.includes('effect') || cmd.includes('ate')) return 'Quantify causal impact once model diagnostics look reasonable.';
            if (cmd.includes('fit model')) return 'Move from structure validation to parameter learning.';
            if (cmd.includes('test')) return 'Validate DAG assumptions against data before fitting.';
            if (cmd.includes('open dag editor')) return 'Adjust causal structure when assumptions fail or need refinement.';
            if (cmd.includes('report')) return 'Capture current results in a reproducible summary.';
            return 'This is a recommended next step in the guided workflow.';
        }

        function inferWorkflowPhaseFromText(text) {
            const lower = (text || '').toLowerCase();
            if (!lower) return;
            if (lower.includes('stage 4: model fit completed') || lower.includes('model fitted successfully')) {
                workflowPhase = 'fit';
                return;
            }
            if (lower.includes('sampling results') || lower.includes('model fit check')) {
                workflowPhase = 'sample_qc';
                return;
            }
            if (lower.includes('average treatment effect') || lower.includes(' ate')) {
                workflowPhase = 'ate';
                return;
            }
            if (lower.includes('stage 3: dag test') || lower.includes('consistency test results')) {
                workflowPhase = 'test';
                return;
            }
            if (lower.includes('stage 2: dag proposal') || lower.includes('proposed dag structure')) {
                workflowPhase = 'dag';
            }
        }
        
        function sendAction(command) {
            // Fill input with command and send
            const input = document.getElementById('message-input');
            const normalizedCommand = (command || '').toLowerCase().trim();
            // Remove "Click the..." prefix if present
            if (command.startsWith('Click the')) {
                // This is a UI action, handle it differently
                if (command.includes('Upload Data')) {
                    document.getElementById('file-input').click();
                    return;
                }
                if (command.includes('Upload DAG CSV')) {
                    document.getElementById('dag-file-input').click();
                    return;
                }
            }
            // Natural-language upload intents for DAG CSV.
            if (
                normalizedCommand.includes('upload dag csv') ||
                normalizedCommand.includes('upload a dag csv') ||
                normalizedCommand.includes('upload dag file')
            ) {
                document.getElementById('dag-file-input').click();
                return;
            }
            input.value = command;
            // Show loading indicator immediately when action is triggered
            const loadingId = showLoadingIndicator('Processing your request...');
            sendMessage();
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function removeMessage(id) {
            const element = document.getElementById(id);
            if (element) {
                element.remove();
            }
        }
        
        function showLoadingIndicator(statusText = 'Calculating...') {
            // Remove any existing loading indicator first
            hideLoadingIndicator();
            
            const container = document.getElementById('messages-container');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.className = 'calculating-message';
            loadingDiv.innerHTML = `
                <div class="loading-dots">
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                </div>
                <span class="loading-text">${escapeHtml(statusText)}</span>
            `;
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;
            
            return loadingDiv.id;
        }
        
        function hideLoadingIndicator(id = null) {
            // If specific ID provided, remove that one
            if (id) {
                removeMessage(id);
            } else {
                // Otherwise, remove all loading indicators
                const loadingIndicators = document.querySelectorAll('#loading-indicator, .calculating-message');
                loadingIndicators.forEach(indicator => {
                    indicator.remove();
                });
                // Also remove old-style typing indicators
                const typingIndicators = document.querySelectorAll('.message.assistant');
                typingIndicators.forEach(msg => {
                    if (msg.textContent.includes('Thinking...') || msg.textContent.includes('Processing...') || msg.textContent.includes('Calculating...')) {
                        const hasOnlyLoading = msg.querySelector('.progress-indicator, .loading-dots');
                        if (hasOnlyLoading && msg.textContent.trim().length < 50) {
                            msg.remove();
                        }
                    }
                });
            }
        }
        
        function updateStatus(text) {
            document.getElementById('status-text').textContent = text;
        }
        
        function updateStepIndicator() {
            const phaseByStep = {
                'initial': 'data',
                'dag_proposed': 'dag',
                'dag_tested': 'test',
                'dag_finalized': 'fit',
                'model_fitted': 'fit',
                'sampled': 'sample_qc',
                'ate_computed': 'ate'
            };
            if (currentStep && phaseByStep[currentStep]) {
                workflowPhase = phaseByStep[currentStep];
            }
            const strip = document.getElementById('workflow-strip');
            if (!strip) return;
            const phases = [
                { id: 'data', label: 'Data' },
                { id: 'dag', label: 'DAG' },
                { id: 'test', label: 'Test' },
                { id: 'fit', label: 'Fit' },
                { id: 'sample_qc', label: 'Sample' },
                { id: 'ate', label: 'ATE' }
            ];
            const indexById = Object.fromEntries(phases.map((p, i) => [p.id, i]));
            const activeIdx = indexById[workflowPhase] ?? 0;
            strip.innerHTML = phases.map((p, i) => {
                const cls = i < activeIdx ? 'workflow-pill completed' : (i === activeIdx ? 'workflow-pill active' : 'workflow-pill');
                return `<span class="${cls}">${p.label}</span>`;
            }).join('');
        }
        
        // Download report button
        document.getElementById('download-report-btn').addEventListener('click', async () => {
            if (!sessionId) {
                alert('No active session. Please start a conversation first.');
                return;
            }
            
            try {
                updateStatus('Generating PDF report...');
                const response = await fetch(`/api/generate_report?session_id=${sessionId}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `causal_analysis_report_${sessionId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    hideLoadingIndicator(loadingId);
                    updateStatus('Report downloaded');
                    addMessage('assistant', '**Report downloaded successfully.**\n\nThe PDF report includes:\n- DAG structure visualization\n- Training loss history\n- Sampling distributions\n- Intervention results (if available)');
                } else {
                    hideLoadingIndicator(loadingId);
                    const errorText = await response.text();
                    alert(`Error generating report: ${errorText}`);
                    updateStatus('Report generation failed');
                }
            } catch (error) {
                hideLoadingIndicator(loadingId);
                console.error('Error downloading report:', error);
                alert(`Error downloading report: ${error.message}`);
                updateStatus('Download error');
            }
        });
        
        // File upload function - defined after all helper functions are available
        window.uploadFile = async function() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            
            if (!file) {
                console.warn('No file selected');
                addMessage('assistant', 'No file selected. Please choose a CSV or Excel file.');
                return;
            }
            
            console.log('Uploading file:', file.name, 'Size:', file.size, 'Type:', file.type);
            updateStatus('Uploading file...');
            const loadingId = showLoadingIndicator('Uploading file...');
            
            const formData = new FormData();
            formData.append('file', file);
            if (sessionId) {
                formData.append('session_id', sessionId);
                console.log('Including session_id in upload:', sessionId);
            } else {
                console.log('No session_id, server will create one');
            }
            
            try {
                console.log('Sending upload request to /api/upload_data');
                const response = await fetch('/api/upload_data', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Upload response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Upload failed with status:', response.status, 'Error:', errorText);
                    hideLoadingIndicator(loadingId);
                    addMessage('assistant', `Upload failed (HTTP ${response.status}): ${errorText}`);
                    updateStatus('Upload failed');
                    fileInput.value = '';
                    return;
                }
                
                const data = await response.json();
                console.log('Upload response data:', data);
                
                if (data.status === 'uploaded') {
                    sessionId = data.session_id;
                    console.log('Session ID set from upload:', sessionId);
                    // Store in localStorage to persist across page refreshes
                    localStorage.setItem('chatbot_session_id', sessionId);
                    hideLoadingIndicator(loadingId);
                    let uploadMsg = `Data uploaded successfully.\n\n` +
                        `**File**: ${file.name}\n` +
                        `**Shape**: ${data.data_info.shape[0]} rows × ${data.data_info.shape[1]} columns\n` +
                        `**Variables**: ${data.data_info.columns.join(', ')}\n\n`;
                    if (data.data_pairplot_url) {
                        uploadMsg += `**Data Pairplot Preview:**\n![Uploaded Data Pairplot](${data.data_pairplot_url})\n\n`;
                    }
                    uploadMsg +=
                        `---\n\n**What would you like to do next?**\n\n` +
                        `1. **Get an LLM-proposed DAG**\n   → Type: \`propose a dag\`\n   Let the assistant suggest a causal structure from your variable names\n\n` +
                        `2. **Manually build/edit a DAG**\n   → Type: \`open dag editor\`\n   Use the visual DAG editor to add or remove edges yourself\n\n` +
                        `3. **Upload a DAG CSV file**\n   → Type: \`upload dag csv\`\n   Upload your edge CSV and I will detect it as a DAG file (expected columns like source,target)\n\n` +
                        `4. **Open full-size pairplot**\n   → Type: \`open uploaded pairplot\`\n   Show the uploaded data pairplot again in full chat view\n\n`;
                    addMessage('assistant', uploadMsg);
                    updateStatus('Data uploaded');
                } else {
                    hideLoadingIndicator(loadingId);
                    console.error('Upload failed:', data);
                    addMessage('assistant', `Upload failed: ${data.error || 'Unknown error'}`);
                    updateStatus('Upload failed');
                }
            } catch (error) {
                hideLoadingIndicator(loadingId);
                console.error('Upload error:', error);
                addMessage('assistant', `Error uploading file: ${error.message}\n\nPlease check the browser console (F12) for details.`);
                updateStatus('Upload error');
            }
            
            // Reset file input
            fileInput.value = '';
        };

        window.uploadDagCsvFile = async function() {
            const fileInput = document.getElementById('dag-file-input');
            const file = fileInput.files[0];

            if (!file) {
                return;
            }
            if (!sessionId) {
                addMessage('assistant', 'No active session. Please upload your data first.');
                fileInput.value = '';
                return;
            }

            updateStatus('Uploading DAG CSV...');
            const loadingId = showLoadingIndicator('Uploading DAG CSV...');

            const formData = new FormData();
            formData.append('file', file);
            formData.append('session_id', sessionId);

            try {
                const response = await fetch('/api/upload_dag_csv', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (!response.ok || data.status !== 'uploaded') {
                    hideLoadingIndicator(loadingId);
                    addMessage('assistant', `DAG CSV upload failed: ${data.error || data.detail || 'Unknown error'}`);
                    updateStatus('DAG CSV upload failed');
                    fileInput.value = '';
                    return;
                }

                hideLoadingIndicator(loadingId);

                let edgeLines = '(no edges)';
                if (data.edges && data.edges.length > 0) {
                    edgeLines = data.edges.map(e => `- ${e[0]} → ${e[1]}`).join('\n');
                }

                addMessage('assistant',
                    `**DAG imported from CSV successfully.**\n\n` +
                    `**Edges (${data.edge_count}):**\n${edgeLines}\n\n` +
                    `---\n\n**What would you like to do next?**\n\n` +
                    `1. **Test this DAG against your data**\n   → Type: \`yes, test the model\`\n   Run conditional independence tests to validate the imported DAG\n\n` +
                    `2. **Open DAG editor**\n   → Type: \`open dag editor\`\n   Visually refine imported edges before testing\n\n` +
                    `3. **Fit model**\n   → Type: \`fit model\`\n   Proceed directly to TRAM-DAG fitting\n\n`
                );
                updateStatus('DAG CSV uploaded');
            } catch (error) {
                hideLoadingIndicator(loadingId);
                addMessage('assistant', `Error uploading DAG CSV: ${error.message}`);
                updateStatus('DAG CSV upload error');
            }

            fileInput.value = '';
        };
        
        // ================================================================
        // Interactive DAG Editor (Cytoscape.js)
        // ================================================================
        let dagEditorCy = null;       // Cytoscape instance
        let dagEditorSource = null;   // Currently selected source node id
        let dagEditorEdges = [];      // Array of {source, target} objects
        let dagEditorCIOverlays = []; // Array of CI overlays
        let reopenEditorAfterRetest = false; // Re-open editor once CI results arrive
        let interventionMeta = null;  // Percentiles and defaults for chooser
        let interventionClickTarget = 'control'; // alternates control -> treated

        async function openDagEditor() {
            if (!sessionId) {
                addMessage('assistant', 'No active session. Please upload your data first.');
                return;
            }

            // Fetch current variables and edges from the backend
            try {
                const resp = await fetch(`/api/dag_editor_data?session_id=${encodeURIComponent(sessionId)}`);
                if (!resp.ok) {
                    addMessage('assistant', 'Could not load DAG editor data. Please try again.');
                    return;
                }
                const data = await resp.json();
                const variables = data.variables || [];
                const nodes = data.nodes || variables.map(v => ({ id: v, label: v }));
                const existingEdges = data.edge_objects || data.edges || [];
                dagEditorCIOverlays = data.ci_overlays || [];

                if (variables.length === 0) {
                    addMessage('assistant', 'No variables found. Please upload data first.');
                    return;
                }

                // Initialize edges from existing DAG
                dagEditorEdges = existingEdges.map(e => ({
                    source: Array.isArray(e) ? e[0] : e.source || e[0],
                    target: Array.isArray(e) ? e[1] : e.target || e[1]
                }));
                dagEditorSource = null;

                // Show the modal
                document.getElementById('dag-editor-overlay').classList.add('active');

                // Build cytoscape elements
                const nodeElements = nodes.map((n) => ({
                    data: { id: n.id, label: n.label || n.id }
                }));
                const edgeElements = dagEditorEdges.map((e, i) => ({
                    data: { id: `e${i}`, source: e.source, target: e.target }
                }));
                const ciOverlayElements = dagEditorCIOverlays.map((e, i) => ({
                    data: {
                        id: `ci_${i}`,
                        source: e.source,
                        target: e.target,
                        label: e.label || 'Rejected CI'
                    },
                    classes:
                        e.status === 'rejected'
                            ? 'ci-overlay ci-overlay-rejected'
                            : e.status === 'passed'
                                ? 'ci-overlay ci-overlay-passed'
                                : 'ci-overlay ci-overlay-implied'
                }));

                // Destroy previous instance if it exists
                if (dagEditorCy) {
                    dagEditorCy.destroy();
                    dagEditorCy = null;
                }

                dagEditorCy = cytoscape({
                    container: document.getElementById('dag-editor-canvas'),
                    elements: [...nodeElements, ...edgeElements, ...ciOverlayElements],
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'background-color': '#2C5F7D',
                                'label': 'data(label)',
                                'color': '#fff',
                                'text-valign': 'center',
                                'text-halign': 'center',
                                'font-size': '14px',
                                'font-weight': 'bold',
                                'width': 60,
                                'height': 60,
                                'border-width': 3,
                                'border-color': '#1e4a5f'
                            }
                        },
                        {
                            selector: 'node.source-selected',
                            style: {
                                'background-color': '#059669',
                                'border-color': '#047857',
                                'border-width': 4
                            }
                        },
                        {
                            selector: 'node:active',
                            style: {
                                'overlay-opacity': 0.1
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'width': 3,
                                'line-color': '#6B7280',
                                'target-arrow-color': '#6B7280',
                                'target-arrow-shape': 'triangle',
                                'curve-style': 'bezier',
                                'arrow-scale': 1.5
                            }
                        },
                        {
                            selector: 'edge:active',
                            style: {
                                'line-color': '#DC2626',
                                'target-arrow-color': '#DC2626',
                                'overlay-opacity': 0.1
                            }
                        },
                        {
                            selector: 'edge.ci-overlay',
                            style: {
                                'width': 2,
                                'line-style': 'dashed',
                                'target-arrow-shape': 'none',
                                'opacity': 0.65
                            }
                        },
                        {
                            selector: 'edge.ci-overlay-rejected',
                            style: {
                                'line-color': '#DC2626',
                                'target-arrow-color': '#DC2626'
                            }
                        },
                        {
                            selector: 'edge.ci-overlay-passed',
                            style: {
                                'line-color': '#059669',
                                'target-arrow-color': '#059669'
                            }
                        },
                        {
                            selector: 'edge.ci-overlay-implied',
                            style: {
                                'line-color': '#D97706',
                                'target-arrow-color': '#D97706'
                            }
                        }
                    ],
                    layout: {
                        name: 'circle',
                        padding: 50
                    },
                    userZoomingEnabled: true,
                    userPanningEnabled: true,
                    boxSelectionEnabled: false
                });

                // Node click handler: select source, then target to add edge
                dagEditorCy.on('tap', 'node', function(evt) {
                    const nodeId = evt.target.id();

                    if (dagEditorSource === null) {
                        // First click: select source
                        dagEditorSource = nodeId;
                        evt.target.addClass('source-selected');
                        updateDagEditorStatus(`Source: <strong>${nodeId}</strong> selected. Now click the target node.`, true);
                    } else if (dagEditorSource === nodeId) {
                        // Clicked same node: deselect
                        evt.target.removeClass('source-selected');
                        dagEditorSource = null;
                        updateDagEditorStatus('Selection cancelled. Click a source node to begin.');
                    } else {
                        // Second click: add edge from source to this target
                        const target = nodeId;
                        const source = dagEditorSource;

                        // Check if edge already exists
                        const exists = dagEditorEdges.some(e => e.source === source && e.target === target);
                        if (!exists) {
                            // Check for reverse edge (would create a cycle of length 2)
                            const reverseExists = dagEditorEdges.some(e => e.source === target && e.target === source);
                            if (reverseExists) {
                                updateDagEditorStatus(`Cannot add ${source} → ${target}: reverse edge already exists (would create a cycle).`);
                            } else {
                                const edgeId = `e${Date.now()}`;
                                dagEditorEdges.push({ source, target });
                                dagEditorCy.add({
                                    data: { id: edgeId, source: source, target: target }
                                });
                                // Remove any rejected-CI overlay for the same pair once the edge is explicitly added.
                                const overlayId = dagEditorCy.edges('.ci-overlay').filter(edge =>
                                    edge.data('source') === source && edge.data('target') === target
                                ).id();
                                if (overlayId) {
                                    dagEditorCy.getElementById(overlayId).remove();
                                }
                                updateDagEditorStatus(`Added edge: ${source} → ${target}`);
                            }
                        } else {
                            updateDagEditorStatus(`Edge ${source} → ${target} already exists.`);
                        }

                        // Deselect source
                        dagEditorCy.getElementById(source).removeClass('source-selected');
                        dagEditorSource = null;
                        updateDagEditorEdgeList();
                    }
                });

                // Edge click handler: remove edge
                dagEditorCy.on('tap', 'edge', function(evt) {
                    if (evt.target.hasClass('ci-overlay')) {
                        updateDagEditorStatus('Rejected CI overlay edges are hints and cannot be deleted directly.');
                        return;
                    }
                    const edgeData = evt.target.data();
                    // Remove from our edge list
                    dagEditorEdges = dagEditorEdges.filter(
                        e => !(e.source === edgeData.source && e.target === edgeData.target)
                    );
                    // Remove from cytoscape
                    evt.target.remove();
                    // Clear source selection if any
                    if (dagEditorSource) {
                        dagEditorCy.getElementById(dagEditorSource).removeClass('source-selected');
                        dagEditorSource = null;
                    }
                    updateDagEditorStatus(`Removed edge: ${edgeData.source} → ${edgeData.target}`);
                    updateDagEditorEdgeList();
                });

                // Background click: deselect source
                dagEditorCy.on('tap', function(evt) {
                    if (evt.target === dagEditorCy) {
                        if (dagEditorSource) {
                            dagEditorCy.getElementById(dagEditorSource).removeClass('source-selected');
                            dagEditorSource = null;
                            updateDagEditorStatus('Selection cancelled. Click a source node to begin.');
                        }
                    }
                });

                updateDagEditorEdgeList();

            } catch (err) {
                console.error('Error opening DAG editor:', err);
                addMessage('assistant', `Error opening DAG editor: ${err.message}`);
            }
        }

        async function openInterventionChooser() {
            if (!sessionId) {
                addMessage('assistant', 'No active session. Please upload your data first.');
                return;
            }
            try {
                const resp = await fetch(`/api/intervention_chooser_data?session_id=${encodeURIComponent(sessionId)}`);
                const data = await resp.json();
                if (!resp.ok) {
                    addMessage('assistant', `Could not load intervention chooser: ${data.detail || 'Unknown error'}`);
                    return;
                }
                interventionMeta = data;
                document.getElementById('intervention-overlay').classList.add('active');

                const s = data.summary || {};
                document.getElementById('control-value-input').value = (data.defaults?.x_control ?? s.p25 ?? 0.0).toString();
                document.getElementById('treated-value-input').value = (data.defaults?.x_treated ?? s.p75 ?? 1.0).toString();
                document.getElementById('intervention-status').innerHTML =
                    `Treatment variable: <strong>${escapeHtml(data.treatment_variable)}</strong> — range [${Number(s.min).toFixed(3)}, ${Number(s.max).toFixed(3)}]. Click in the plot to set <strong>control</strong> then <strong>treated</strong>, or drag the vertical bars to fine-tune.`;
                interventionClickTarget = 'control';

                renderTramTreatmentPlot();
                document.getElementById('control-value-input').oninput = renderTramTreatmentPlot;
                document.getElementById('treated-value-input').oninput = renderTramTreatmentPlot;
            } catch (err) {
                addMessage('assistant', `Error opening intervention chooser: ${err.message}`);
            }
        }

        function estimateDensity(values, xGrid) {
            const n = values.length;
            if (!n) return xGrid.map(() => 0);
            const mean = values.reduce((a, b) => a + b, 0) / n;
            const variance = values.reduce((a, b) => a + ((b - mean) ** 2), 0) / Math.max(1, n - 1);
            const std = Math.sqrt(Math.max(variance, 1e-12));
            const bw = Math.max(1.06 * std * (n ** (-1 / 5)), 1e-6);
            const coeff = 1 / (Math.sqrt(2 * Math.PI) * bw * n);
            return xGrid.map(x => {
                let sum = 0;
                for (let i = 0; i < n; i++) {
                    const z = (x - values[i]) / bw;
                    sum += Math.exp(-0.5 * z * z);
                }
                return coeff * sum;
            });
        }

        function renderTramTreatmentPlot() {
            if (!interventionMeta) return;
            const values = (interventionMeta.values || []).map(Number).filter(v => Number.isFinite(v));
            const s = interventionMeta.summary || {};
            const xVar = interventionMeta.treatment_variable || 'Treatment';
            const control = parseFloat(document.getElementById('control-value-input').value);
            const treated = parseFloat(document.getElementById('treated-value-input').value);
            const vMin = Number.isFinite(s.min) ? Number(s.min) : Math.min(...values);
            const vMax = Number.isFinite(s.max) ? Number(s.max) : Math.max(...values);
            const xGrid = [];
            const gridN = 240;
            const span = Math.max(vMax - vMin, 1e-6);
            for (let i = 0; i < gridN; i++) {
                xGrid.push(vMin + (span * i) / (gridN - 1));
            }
            const kdeY = estimateDensity(values, xGrid);

            const traces = [
                {
                    x: values,
                    type: 'histogram',
                    histnorm: 'probability density',
                    nbinsx: 40,
                    marker: { color: 'rgba(41,128,185,0.25)', line: { color: '#2980b9', width: 1 } },
                    name: 'Data distribution',
                    hovertemplate: `${xVar}: %{x}<br>Density: %{y}<extra></extra>`
                },
                {
                    x: xGrid,
                    y: kdeY,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#154360', width: 2 },
                    name: 'Data distribution'
                }
            ];

            const shapes = [];
            const annotations = [];
            if (Number.isFinite(control)) {
                shapes.push({ type: 'line', x0: control, x1: control, y0: 0, y1: 1, yref: 'paper', line: { color: '#5dade2', width: 2.5, dash: 'dash' } });
                annotations.push({ x: control, y: 1, yref: 'paper', text: `ctrl=${control.toFixed(3)}`, showarrow: false, yanchor: 'bottom', font: { color: '#5dade2', size: 11 } });
            }
            if (Number.isFinite(treated)) {
                shapes.push({ type: 'line', x0: treated, x1: treated, y0: 0, y1: 1, yref: 'paper', line: { color: '#1a5276', width: 2.5, dash: 'solid' } });
                annotations.push({ x: treated, y: 1, yref: 'paper', text: `do(${xVar}=${treated.toFixed(3)})`, showarrow: false, yanchor: 'bottom', font: { color: '#1a5276', size: 11 } });
            }

            Plotly.newPlot('intervention-plot', traces, {
                title: `Distribution of ${xVar}`,
                margin: { t: 40, r: 16, b: 50, l: 55 },
                xaxis: { title: xVar },
                yaxis: { title: 'Density' },
                shapes,
                annotations,
                legend: {
                    x: 0.99,
                    y: 0.99,
                    xanchor: 'right',
                    yanchor: 'top',
                    bgcolor: '#ffffff',
                    bordercolor: '#c8ddf0',
                    borderwidth: 1
                },
                bargap: 0.02
            }, {
                responsive: true,
                displayModeBar: false,
                editable: true,
                edits: { shapePosition: true }
            });

            const plotEl = document.getElementById('intervention-plot');
            if (plotEl && typeof plotEl.removeAllListeners === 'function') {
                plotEl.removeAllListeners('plotly_click');
                plotEl.removeAllListeners('plotly_relayout');
            }
            if (plotEl && typeof plotEl.on === 'function') {
                plotEl.on('plotly_click', (eventData) => {
                    const point = eventData && eventData.points && eventData.points[0];
                    if (!point || !Number.isFinite(Number(point.x))) return;
                    const clickedValue = Number(point.x);
                    const controlInput = document.getElementById('control-value-input');
                    const treatedInput = document.getElementById('treated-value-input');
                    if (interventionClickTarget === 'control') {
                        controlInput.value = clickedValue.toFixed(6);
                        interventionClickTarget = 'treated';
                        document.getElementById('intervention-status').innerHTML =
                            `Set <strong>control</strong> to ${clickedValue.toFixed(4)}. Click again to set <strong>treated</strong>.`;
                    } else {
                        treatedInput.value = clickedValue.toFixed(6);
                        interventionClickTarget = 'control';
                        const controlVal = parseFloat(controlInput.value);
                        const delta = Number.isFinite(controlVal) ? (clickedValue - controlVal) : null;
                        document.getElementById('intervention-status').innerHTML =
                            delta === null
                                ? `Set <strong>treated</strong> to ${clickedValue.toFixed(4)}.`
                                : `Set <strong>treated</strong> to ${clickedValue.toFixed(4)} (delta = ${(delta >= 0 ? '+' : '') + delta.toFixed(4)}). Next click sets <strong>control</strong>.`;
                    }
                    renderTramTreatmentPlot();
                });

                plotEl.on('plotly_relayout', (relayoutData) => {
                    if (!relayoutData) return;
                    const controlInput = document.getElementById('control-value-input');
                    const treatedInput = document.getElementById('treated-value-input');
                    const hasControl = Number.isFinite(control);
                    const hasTreated = Number.isFinite(treated);
                    const controlIdx = hasControl ? 0 : -1;
                    const treatedIdx = hasTreated ? (hasControl ? 1 : 0) : -1;

                    const getShapeX = (idx) => {
                        if (idx < 0) return null;
                        const key = `shapes[${idx}].x0`;
                        if (Object.prototype.hasOwnProperty.call(relayoutData, key)) {
                            const v = Number(relayoutData[key]);
                            return Number.isFinite(v) ? v : null;
                        }
                        if (Array.isArray(relayoutData.shapes) && relayoutData.shapes[idx]) {
                            const v = Number(relayoutData.shapes[idx].x0);
                            return Number.isFinite(v) ? v : null;
                        }
                        return null;
                    };

                    let updated = false;
                    const movedControl = getShapeX(controlIdx);
                    const movedTreated = getShapeX(treatedIdx);
                    if (movedControl !== null) {
                        controlInput.value = movedControl.toFixed(6);
                        updated = true;
                    }
                    if (movedTreated !== null) {
                        treatedInput.value = movedTreated.toFixed(6);
                        updated = true;
                    }
                    if (!updated) return;

                    const cVal = parseFloat(controlInput.value);
                    const tVal = parseFloat(treatedInput.value);
                    if (Number.isFinite(cVal) && Number.isFinite(tVal)) {
                        const delta = tVal - cVal;
                        document.getElementById('intervention-status').innerHTML =
                            `Adjusted bars by drag — control=${cVal.toFixed(4)}, treated=${tVal.toFixed(4)}, delta=${(delta >= 0 ? '+' : '') + delta.toFixed(4)}.`;
                    }
                    renderTramTreatmentPlot();
                });
            }
        }

        function closeInterventionChooser() {
            document.getElementById('intervention-overlay').classList.remove('active');
        }

        function openPlotZoom(src) {
            if (!src) return;
            const overlay = document.getElementById('plot-zoom-overlay');
            const img = document.getElementById('plot-zoom-image');
            const stage = document.getElementById('plot-zoom-stage');
            img.src = src;
            plotZoomScale = 1;
            img.style.transform = `scale(${plotZoomScale})`;
            stage.scrollTop = 0;
            stage.scrollLeft = 0;
            overlay.classList.add('active');
        }

        function closePlotZoom(event) {
            if (event && event.target && event.target.id && event.target.id !== 'plot-zoom-overlay') {
                return;
            }
            const overlay = document.getElementById('plot-zoom-overlay');
            const img = document.getElementById('plot-zoom-image');
            overlay.classList.remove('active');
            img.removeAttribute('src');
        }

        function zoomPlotBy(factor) {
            plotZoomScale = Math.max(0.5, Math.min(8, plotZoomScale * factor));
            document.getElementById('plot-zoom-image').style.transform = `scale(${plotZoomScale})`;
        }

        function resetPlotZoom() {
            plotZoomScale = 1;
            document.getElementById('plot-zoom-image').style.transform = 'scale(1)';
        }

        function setInterventionPreset(preset) {
            if (!interventionMeta || !interventionMeta.summary) return;
            const s = interventionMeta.summary;
            if (preset === 'p25_p75') {
                document.getElementById('control-value-input').value = Number(s.p25).toFixed(6);
                document.getElementById('treated-value-input').value = Number(s.p75).toFixed(6);
            } else if (preset === 'p10_p90') {
                document.getElementById('control-value-input').value = Number(s.p10).toFixed(6);
                document.getElementById('treated-value-input').value = Number(s.p90).toFixed(6);
            } else {
                document.getElementById('control-value-input').value = String(interventionMeta.defaults?.x_control ?? 0.0);
                document.getElementById('treated-value-input').value = String(interventionMeta.defaults?.x_treated ?? 1.0);
            }
            renderTramTreatmentPlot();
        }

        function applyInterventionValues() {
            const control = parseFloat(document.getElementById('control-value-input').value);
            const treated = parseFloat(document.getElementById('treated-value-input').value);
            if (!Number.isFinite(control) || !Number.isFinite(treated)) {
                document.getElementById('intervention-status').textContent = 'Please enter valid numeric values.';
                return;
            }
            if (treated === control) {
                document.getElementById('intervention-status').textContent = 'Choose different treated and control values.';
                return;
            }
            closeInterventionChooser();
            sendAction(`treated ${treated}, control ${control}`);
        }

        function closeDagEditor() {
            document.getElementById('dag-editor-overlay').classList.remove('active');
            if (dagEditorCy) {
                dagEditorCy.destroy();
                dagEditorCy = null;
            }
            dagEditorSource = null;
        }

        function clearDagEditorEdges() {
            if (!dagEditorCy) return;
            dagEditorCy.edges().remove();
            dagEditorEdges = [];
            dagEditorSource = null;
            dagEditorCy.nodes().removeClass('source-selected');
            updateDagEditorStatus('All edges cleared. Click a source node to begin.');
            updateDagEditorEdgeList();
        }

        function updateDagEditorStatus(text, isSelecting = false) {
            const el = document.getElementById('dag-editor-status');
            el.innerHTML = text;
            el.className = 'dag-editor-status' + (isSelecting ? ' selecting' : '');
        }

        function updateDagEditorEdgeList() {
            const el = document.getElementById('dag-editor-edge-list');
            if (dagEditorEdges.length === 0) {
                el.textContent = 'No edges yet.';
            } else {
                el.innerHTML = '<strong>Edges:</strong> ' +
                    dagEditorEdges.map(e => `${e.source} → ${e.target}`).join(', ');
            }
        }

        async function saveDagFromEditor(retestAfterSave = false) {
            if (!sessionId) {
                alert('No active session.');
                return;
            }

            // Convert edges to the format expected by the backend
            const edgePairs = dagEditorEdges.map(e => [e.source, e.target]);

            try {
                const resp = await fetch('/api/save_dag', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        edges: edgePairs
                    })
                });

                const result = await resp.json();
                if (!resp.ok) {
                    const errText = result.detail || JSON.stringify(result);
                    alert(`Failed to save DAG: ${errText}`);
                    return;
                }

                if (result.status === 'validation_error') {
                    const details = result.details || {};
                    const cycleText = (details.cycle_edges || [])
                        .map(e => `${e[0]} → ${e[1]}`)
                        .join(', ');
                    let message = `Validation issue: ${result.message || 'Please fix edges and try again.'}`;
                    if (cycleText) {
                        message += `\nCycle: ${cycleText}`;
                    }
                    updateDagEditorStatus(message);
                    return;
                }

                // Close the editor
                closeDagEditor();
                currentStep = 'dag_proposed';
                updateStepIndicator();

                // Build confirmation message
                let edgeStr = '';
                if (result.edges && result.edges.length > 0) {
                    edgeStr = result.edges.map(e => {
                        const parent = Array.isArray(e) ? e[0] : e.source || e[0];
                        const child = Array.isArray(e) ? e[1] : e.target || e[1];
                        return `- ${parent} → ${child}`;
                    }).join('\n');
                } else {
                    edgeStr = '(no edges)';
                }

                // Build implied CIs section
                let ciSection = '';
                if (result.implied_cis && result.implied_cis.length > 0) {
                    ciSection = `\n**Implied Conditional Independence Tests (${result.implied_cis.length}):**\n`;
                    ciSection += `These are the testable implications of your DAG (shown as red dashed lines in the plot):\n\n`;
                    result.implied_cis.forEach(ci => {
                        ciSection += `- ${ci}\n`;
                    });
                    ciSection += '\n';
                } else if (result.edge_count > 0) {
                    ciSection = '\n**No implied conditional independence tests** for this DAG structure.\n\n';
                }

                // Build plot section
                let plotSection = '';
                if (result.plot_url) {
                    const sep = result.plot_url.includes('?') ? '&' : '?';
                    plotSection = `\n![DAG with CI Tests](${result.plot_url}${sep}t=${Date.now()})\n\n`;
                }

                let actionSection = `---\n\n**What would you like to do next?**\n\n`;
                const actions = result.next_actions || [];
                if (actions.length > 0) {
                    actions.forEach((a, idx) => {
                        actionSection += `${idx + 1}. **${a.label}**\n   → Type: \`${a.command}\`\n   ${a.description || ''}\n\n`;
                    });
                } else {
                    actionSection +=
                        `1. **Test this DAG against your data**\n   → Type: \`yes, test the model\`\n   Run conditional independence tests to validate the DAG\n\n` +
                        `2. **Open DAG editor again**\n   → Type: \`open dag editor\`\n   Re-open the visual editor to make more changes\n\n`;
                }

                addMessage('assistant',
                    `**DAG saved from the interactive editor.**\n\n` +
                    `${result.feedback || ''}\n\n` +
                    `**Variables:** ${result.variables.join(', ')}\n\n` +
                    `**Edges (${result.edge_count}):**\n${edgeStr}\n\n` +
                    plotSection +
                    ciSection +
                    actionSection
                );

                if (retestAfterSave) {
                    reopenEditorAfterRetest = true;
                    sendAction('yes, test the model');
                }

            } catch (err) {
                console.error('Error saving DAG:', err);
                alert(`Error saving DAG: ${err.message}`);
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            updateStepIndicator();
            initWebSocket();

            // Click any generated plot image to open zoom viewer.
            document.addEventListener('click', (ev) => {
                const target = ev.target;
                if (!(target instanceof HTMLImageElement)) return;
                if (target.id === 'plot-zoom-image') return;
                const src = target.getAttribute('src') || '';
                if (!src) return;
                if (!src.includes('/api/plots/') && !target.closest('.message')) return;
                openPlotZoom(src.startsWith('http') ? src : `${window.location.origin}${src}`);
            });

            const stage = document.getElementById('plot-zoom-stage');
            stage.addEventListener('wheel', (ev) => {
                if (!document.getElementById('plot-zoom-overlay').classList.contains('active')) return;
                ev.preventDefault();
                zoomPlotBy(ev.deltaY < 0 ? 1.08 : 0.92);
            }, { passive: false });
            stage.addEventListener('mousedown', (ev) => {
                plotZoomDrag = { x: ev.clientX, y: ev.clientY, sl: stage.scrollLeft, st: stage.scrollTop };
                stage.classList.add('dragging');
            });
            window.addEventListener('mouseup', () => {
                plotZoomDrag = null;
                stage.classList.remove('dragging');
            });
            window.addEventListener('mousemove', (ev) => {
                if (!plotZoomDrag) return;
                stage.scrollLeft = plotZoomDrag.sl - (ev.clientX - plotZoomDrag.x);
                stage.scrollTop = plotZoomDrag.st - (ev.clientY - plotZoomDrag.y);
            });
        });
    </script>
</body>
</html>
